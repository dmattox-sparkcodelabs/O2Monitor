{% extends "base.html" %}

{% block title %}Settings - {{ app_name }}{% endblock %}

{% block content %}
<div class="settings-page">
    <h1>Settings</h1>

    <div class="settings-sections">
        <!-- Alert Configuration Table -->
        <section class="settings-section">
            <h2>Alert Configuration</h2>
            <p class="section-description">Configure alert thresholds, severity levels, and therapy bypass behavior</p>

            <div class="alert-table-container">
                <table class="alert-table" id="alert-table">
                    <thead>
                        <tr>
                            <th>Alert</th>
                            <th>Enabled</th>
                            <th>Threshold</th>
                            <th>Duration</th>
                            <th>Severity</th>
                            <th title="Skip this alert when AVAPS therapy is active">Bypass on Therapy</th>
                            <th title="Time before alert can fire again">Resend</th>
                            <th>Test</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-alert="spo2_critical_off_therapy">
                            <td>
                                <strong>SpO2 Critical (Off Therapy)</strong>
                                <span class="alert-desc">Oxygen low when not on AVAPS</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="70" max="95" value="90"><span class="unit">%</span></span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-duration" min="0.5" max="5" step="0.5" value="0.5"><span class="unit">m</span></span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical" selected>Critical</option>
                                    <option value="high">High</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><span class="na">-</span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="0.5" max="120" step="0.5" value="1"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="spo2_critical_off_therapy">Test</button></td>
                        </tr>
                        <tr data-alert="spo2_critical_on_therapy">
                            <td>
                                <strong>SpO2 Critical (On Therapy)</strong>
                                <span class="alert-desc">Oxygen low during AVAPS use</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="70" max="95" value="85"><span class="unit">%</span></span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-duration" min="0.5" max="10" step="0.5" value="2"><span class="unit">m</span></span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical" selected>Critical</option>
                                    <option value="high">High</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><span class="na">-</span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="0.5" max="120" step="0.5" value="1"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="spo2_critical_on_therapy">Test</button></td>
                        </tr>
                        <tr data-alert="spo2_warning">
                            <td>
                                <strong>SpO2 Warning</strong>
                                <span class="alert-desc">Early warning before critical</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="75" max="98" value="92"><span class="unit">%</span></span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-duration" min="0.5" max="5" step="0.5" value="1"><span class="unit">m</span></span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical">Critical</option>
                                    <option value="high">High</option>
                                    <option value="warning" selected>Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><input type="checkbox" class="alert-bypass-therapy" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="0.5" max="120" step="0.5" value="5"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="spo2_warning">Test</button></td>
                        </tr>
                        <tr data-alert="hr_high">
                            <td>
                                <strong>HR High</strong>
                                <span class="alert-desc">Heart rate too high</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="80" max="200" value="120"><span class="unit">bpm</span></span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-duration" min="0.5" max="5" step="0.5" value="1"><span class="unit">m</span></span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical">Critical</option>
                                    <option value="high" selected>High</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><input type="checkbox" class="alert-bypass-therapy" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="0.5" max="120" step="0.5" value="5"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="hr_high">Test</button></td>
                        </tr>
                        <tr data-alert="hr_low">
                            <td>
                                <strong>HR Low</strong>
                                <span class="alert-desc">Heart rate too low</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="30" max="70" value="50"><span class="unit">bpm</span></span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-duration" min="0.5" max="5" step="0.5" value="1"><span class="unit">m</span></span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical">Critical</option>
                                    <option value="high" selected>High</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><input type="checkbox" class="alert-bypass-therapy" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="0.5" max="120" step="0.5" value="5"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="hr_low">Test</button></td>
                        </tr>
                        <tr data-alert="disconnect">
                            <td>
                                <strong>Disconnect</strong>
                                <span class="alert-desc">Oximeter connection lost</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="1" max="480" value="120"><span class="unit">m</span></span></td>
                            <td><span class="na">-</span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical">Critical</option>
                                    <option value="high">High</option>
                                    <option value="warning" selected>Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><input type="checkbox" class="alert-bypass-therapy" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="1" max="120" step="0.5" value="30"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="disconnect">Test</button></td>
                        </tr>
                        <tr data-alert="no_therapy_at_night_info">
                            <td>
                                <strong>No Therapy at Night (Info)</strong>
                                <span class="alert-desc">Initial notice during sleep hours</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="1" max="180" value="30"><span class="unit">m</span></span></td>
                            <td><span class="na">-</span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical">Critical</option>
                                    <option value="high">High</option>
                                    <option value="warning">Warning</option>
                                    <option value="info" selected>Info</option>
                                </select>
                            </td>
                            <td><span class="na">-</span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="1" max="120" step="0.5" value="30"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="no_therapy_at_night_info">Test</button></td>
                        </tr>
                        <tr data-alert="no_therapy_at_night_high">
                            <td>
                                <strong>No Therapy at Night (Urgent)</strong>
                                <span class="alert-desc">Escalated alert during sleep hours</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="1" max="240" value="60"><span class="unit">m</span></span></td>
                            <td><span class="na">-</span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical">Critical</option>
                                    <option value="high" selected>High</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><span class="na">-</span></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="1" max="120" step="0.5" value="30"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="no_therapy_at_night_high">Test</button></td>
                        </tr>
                        <tr data-alert="battery_warning">
                            <td>
                                <strong>Battery Warning</strong>
                                <span class="alert-desc">Oximeter battery low</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="5" max="50" value="25"><span class="unit">%</span></span></td>
                            <td><span class="na">-</span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical">Critical</option>
                                    <option value="high">High</option>
                                    <option value="warning" selected>Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><input type="checkbox" class="alert-bypass-therapy"></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="1" max="120" step="0.5" value="60"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="battery_warning">Test</button></td>
                        </tr>
                        <tr data-alert="battery_critical">
                            <td>
                                <strong>Battery Critical</strong>
                                <span class="alert-desc">Oximeter battery very low</span>
                            </td>
                            <td><input type="checkbox" class="alert-enabled" checked></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-threshold" min="5" max="30" value="10"><span class="unit">%</span></span></td>
                            <td><span class="na">-</span></td>
                            <td>
                                <select class="alert-severity">
                                    <option value="critical" selected>Critical</option>
                                    <option value="high">High</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </td>
                            <td><input type="checkbox" class="alert-bypass-therapy"></td>
                            <td><span class="input-with-unit"><input type="number" class="alert-resend" min="1" max="120" step="0.5" value="60"><span class="unit">m</span></span></td>
                            <td><button class="btn btn-sm btn-test" data-alert-type="battery_critical">Test</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Sleep Hours Configuration -->
        <section class="settings-section">
            <h2>Sleep Hours</h2>
            <p class="section-description">Define when "No Therapy at Night" alert is active</p>
            <div class="form-row">
                <div class="form-group">
                    <label for="sleep-start">Start Time</label>
                    <input type="time" id="sleep-start" value="22:00">
                </div>
                <div class="form-group">
                    <label for="sleep-end">End Time</label>
                    <input type="time" id="sleep-end" value="07:00">
                </div>
            </div>
        </section>

        <!-- Bluetooth Timing -->
        <section class="settings-section">
            <h2>Bluetooth Timing</h2>
            <p class="section-description">Configure Bluetooth connection behavior</p>
            <div class="form-row">
                <div class="form-group">
                    <label for="read-interval">Read Interval</label>
                    <span class="input-with-unit">
                        <input type="number" id="read-interval" min="1" max="60" step="1" value="5">
                        <span class="unit">sec</span>
                    </span>
                    <span class="help-text">How often to poll for readings</span>
                </div>
                <div class="form-group">
                    <label for="late-reading">Late Reading Threshold</label>
                    <span class="input-with-unit">
                        <input type="number" id="late-reading" min="10" max="120" step="5" value="30">
                        <span class="unit">sec</span>
                    </span>
                    <span class="help-text">Reading is "late" after this time</span>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="respawn-delay">Respawn Delay</label>
                    <span class="input-with-unit">
                        <input type="number" id="respawn-delay" min="5" max="60" step="5" value="15">
                        <span class="unit">sec</span>
                    </span>
                    <span class="help-text">Wait time before retrying when device not found</span>
                </div>
                <div class="form-group">
                    <label for="bt-restart-threshold">BT Service Restart</label>
                    <span class="input-with-unit">
                        <input type="number" id="bt-restart-threshold" min="0" max="30" step="1" value="5">
                        <span class="unit">min</span>
                    </span>
                    <span class="help-text">Restart Bluetooth service after this many minutes of failures (0 = disabled)</span>
                </div>
            </div>
        </section>

        <!-- AVAPS Thresholds -->
        <section class="settings-section">
            <h2>AVAPS Power Detection</h2>
            <p class="section-description">If power exceeds threshold within the detection window, therapy is considered ON</p>
            <div class="form-row">
                <div class="form-group">
                    <label for="avaps-on">ON Threshold (Watts)</label>
                    <input type="number" id="avaps-on" min="1" max="100" step="1" value="30">
                    <span class="help-text">Max power in window above this = therapy ON</span>
                </div>
                <div class="form-group">
                    <label for="avaps-window">Detection Window</label>
                    <span class="input-with-unit">
                        <input type="number" id="avaps-window" min="1" max="30" step="1" value="5">
                        <span class="unit">min</span>
                    </span>
                    <span class="help-text">Lookback window for max power detection</span>
                </div>
            </div>
        </section>

        <!-- Audio Settings -->
        <section class="settings-section">
            <h2>Local Audio Alerts</h2>
            <p class="section-description">Play alarm sounds through the Pi's audio output</p>
            <div class="form-row">
                <div class="form-group">
                    <label for="audio-enabled">
                        <input type="checkbox" id="audio-enabled">
                        Enable Local Audio
                    </label>
                    <span class="help-text">Play sounds on the Pi when alerts trigger</span>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="audio-volume">Volume</label>
                    <input type="range" id="audio-volume" min="0" max="100" value="90">
                    <span class="volume-display" id="volume-display">90%</span>
                </div>
                <div class="form-group">
                    <button class="btn btn-sm" id="test-audio">Test Audio</button>
                    <span class="help-text">Play a test sound</span>
                </div>
            </div>
        </section>

        <!-- PagerDuty Integration -->
        <section class="settings-section">
            <h2>PagerDuty Integration</h2>
            <div class="form-group">
                <label for="pagerduty-key">Routing Key</label>
                <input type="text" id="pagerduty-key" placeholder="Events API v2 routing key">
                <span class="help-text">Get from PagerDuty > Service > Integrations</span>
            </div>
            <div class="form-group">
                <label for="pagerduty-token">API Token (Optional)</label>
                <input type="password" id="pagerduty-token" placeholder="REST API user token">
                <span class="help-text">For two-way sync - acknowledging in PagerDuty updates the app</span>
            </div>
        </section>

        <!-- Healthchecks.io Integration -->
        <section class="settings-section">
            <h2>Healthchecks.io Integration</h2>
            <div class="form-group">
                <label for="healthchecks-url">Ping URL</label>
                <input type="url" id="healthchecks-url" placeholder="https://hc-ping.com/your-uuid">
                <span class="help-text">Dead-man switch to detect if monitoring fails</span>
            </div>
        </section>

        <!-- Device Configuration -->
        <section class="settings-section">
            <h2>Device Configuration</h2>
            <div class="form-group">
                <label for="plug-ip">Smart Plug IP Address</label>
                <input type="text" id="plug-ip" placeholder="192.168.1.100">
                <button class="btn btn-sm" id="discover-plugs">Discover Devices</button>
            </div>
            <div id="discovered-devices" class="discovered-devices" style="display: none;"></div>
        </section>

        <!-- Save Button -->
        <div class="settings-actions">
            <button class="btn btn-primary btn-lg" id="save-settings">Save Settings</button>
            <span class="save-status" id="save-status"></span>
        </div>

        <div class="settings-note">
            Settings are saved to config.yaml and persist across restarts.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/settings.js') }}?v=15"></script>
{% endblock %}
